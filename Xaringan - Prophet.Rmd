---
title: "Time Series Analysis with R"
subtitle: "Introduction to Facebook's Prophet"
author: "Kerstin Poetzl"
institute: "Hochschule der Medien Stuttgart"
date: "2019/10/23"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: [default-fonts]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
layout: true

background-image: url("SourcePictures\\Prophet_g4.jpg")
background-size: 1000px
background-position: 100% -1%

---

# Agenda

1. Installed Packages and Libraries
1. Motivation
1. Introduction to Prophet
1. Import data
1. Data Examination
1. Prophet Forecast (FCST)
1. Fazit
1. References

---

# Installed Packages and Libraries

```{r eval=FALSE, message=FALSE, warning=FALSE, results='hide'}
install.packages("ggplot2", repos = "http://cran.us.r-project.org")
install.packages("forecast", repos = "http://cran.us.r-project.org")
install.packages("plotly")
install.packages("prophet", type="source")
install.packages("DT")
```

```{r comment='#', message=FALSE, warning=FALSE, results='hide'}
library(ggplot2)
library(forecast)
library(prophet)
library(plotly)
library(DT)
```

---

# Motivation for this Tutorial

- Business Forecasting
  - central data science task
  - many activities within an company
  - complex problem for machines and most analysts
- Examples
  - effective capacity planning
  - goal setting needs a baseline for performance measurement
  - anomaly detection, etc
- Business Analyst
  - deep domain expertise vs
  - hardly knowledge of time series forecasting techniques

[Taylor/Letham 1, page 1]

This lack of knowledge of many Business Analysts is the major motivation of this tutorial.
The Tutorial shall provide useful guidance how to produce in a simply way a time series forecast of good quality.

---

# Introduction to Prophet

Prophet is:
- an **open source** software for R and Python released by Facebook’s Core Data Science team
- a procedure for **forecasting time series** data
- where non-linear trends are fit with yearly, weekly, and daily seasonality, plus holiday effects
- optimal for time series with strong seasonal effects and several seasons of historical data
- robust to missing data and shifts in the trend
- typically well handling outliers<br>

[Kirenz]

How To forecast with Prophet:
- The `prophet()` function performs fitting and returns a model object
- then call `predict()` to forecast on this model object and 
- `plot()` to visualize the forecast on this model object<br>

[FB]

---

background-image: url("SourcePictures\\Prophet_g5.jpg")
background-size: 1000px
background-position: 100% -1%

# Import data

As data set we use the wikipedia log number of views of <br>
P. Manning who is an ex US American Football Player.<br> 

Source:<br>
- [Peyton Manning at Wikipedia](https://de.wikipedia.org/wiki/Peyton_Manning)<br>
- [Data from github](https://github.com/facebook/prophet/blob/master/examples/example_wp_log_peyton_manning.csv)
<br>
<br>
<br>
<br>
Apply the function `read.table()` with the option to choose the file directly from the local directory.

```{r}
data <- read.table(file.choose(), header = T, sep = ",")
```

---

background-image: url("SourcePictures\\Prophet_g6.jpg")
background-size: 1000px
background-position: 100% -1%


# Data Examination - Data Table

Apply the function `View()` to visualize the data in a separate table tab and `dim()` to understand how many observations the dataframe contains:

```{r}
View(data)
dim(data)

```

Table format looks ok. <br>
Data is properly separated.<br>
Table shows a valid header.

---

# Data Examination - Data Table

Alternative Table view: Apply the function `datatable()` from the library "DT" to retrieve a table of the whole data set incl some navigation options:

```{r}
DT::datatable(data, options = list(pageLength = 4))
```


---

# Data Examination - Data Type

Apply the function `str()` to get a brief glimpse on the data:

```{r}
str(data)
```

--

The date column "ds" is currently stored as a "Factor" data type.

Prerequisition for `Prophet`:

"Prophet needs as input a dataframe with columns for **date (ds)** and the associated numeric **values (y)**.
The date format needs to be **YYYY-MM-DD** for a date or **YYYY-MM-DD HH:MM:SS** for a timestamp." [FB]

---

# Data Examination - Data Type

To ensure proper date format and also for any other visualization purposes this should be converted to a "date-time" class which can be displayed as a continuous variable.

Apply the function `as.Date()` on the column "ds" and replace the old values: 

```{r}
data$ds <- as.Date(data$ds, format = "%Y-%m-%d")
str(data)
```

The data type has been successfully changed from "Factor" to "Date".

---

# Data Examination - Data Summary

Apply the function `summary()` to retrieve a brief statistical overview of the data for Min, Max, Mean, 1st and 3rd Quartile on the dataframe:

```{r}
summary(data)
```

--

In case that the Minimum "Min" would be zero, it has to be decided if this needs to be cleaned up or not.

---

# Data Examination - Data Summary

Although Prophet is robust against missing values, other forecast models like ARIMA would require that missing data need to be handled.

For demonstration purposes we assign NA to all data points where the observation in the dataframe is zero:

```{r}
data$y[data$y==0] <- NA
```

---

# Data Examination - Visualize as Plot

It is a good practice to plot the data and understand how they look like before fitting any models.
Apply the function `ggplot()` here with a selection of simple attributes to define the layout of the scatter plot:

```{r}
plot <- ggplot(data, aes(x= ds, y= y))+
  geom_point(           # used to create scatterplots
    color= "black",     # color of the data points
    shape = 1,          # type of data point (circle, square, filled vs open, etc)
    alpha = 0.4,        # defines the color transparency
    size = 0.6)         # defines the size of the data point
```

Sources:<br>
- [Cheatsheet](https://rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf)<br>
- [Grafiken mit ggplot aus dem package library(ggplot2)](http://md.psych.bio.uni-goettingen.de/mv/unit/ggplot2/ggplot2.html)<br>
- [ggplot2 part of tidyverse](https://ggplot2.tidyverse.org/reference/)<br>
- [Aesthetic specifications](https://ggplot2.tidyverse.org/articles/ggplot2-specs.html)<br>

---

# Data Examination - Visualize as Plot

Apply the function `ggplotly()` to create a plotly object, adjust the size and make the plot interactive, see also [ggplotly](https://www.rdocumentation.org/packages/plotly/versions/4.9.0/topics/ggplotly):

```{r}
ggplotly(plot, width = 750, height = 300)
```

---

# Data Examination - Data ReShape

In case the data set would have many columns and we would like to create a new dataframe with the needed values ds and y only:

Store the values for "date" in the variable "ds" for data stamp information:

```{r}
ds <- data$ds
```

--

**Logarithmic scales:** If the observations have an extrem spread, it's a practical approach to convert the axis on a log scale. See also [wikipedia for logarithmic scales](https://en.wikipedia.org/wiki/Logarithmic_scale).

Store the values for "observations" in the variable "y" and use the `log()` function to convert those to a log scale:

```{r}
y <- log10(data$y)
```

--

Save the 2 variables as new dataframe "df"

```{r}
df <- data.frame(ds,y)
```

---

# Data Examination - Visualize as Plot

Print the new scatter plot. If there would have been a wide spread the seasonality would be now much clearer. But plots are hardly different. Therefore we will continue with the initial dataframe "data" in decimal scale.

```{r}
plot <- ggplot(df, aes(x= ds, y= y))+
      geom_point(color= "black", shape = 1,alpha = 0.4, size = 0.6)
ggplotly(plot, width = 750, height = 300)
```

---

# Prophet FCST - fit the Model

Basically Prophet provides a very simple interface: <br>
with a column of dates and a column of associated numbers it produces a forecast for the time series.

First step is to fit a model on the historical data. It can be done by calling the `prophet()` function using the dataframe as the input. [FB]

Store model for the historical dataframe "data" in "m" by applying the `prophet()` function: 

```{r, warning=FALSE, message=FALSE}
m <- prophet(data)
```

---

# Prophet FCST - check the Model

Have a look into the model and its details:

```{r}
#m
```

---

# Prophet FCST - create future dates

The built-in helper function `make_future_dataframe` creates a dataframe of future dates. 
It requires the input of frequency and number of future periods. 
The historical data is kept for evaluation purposes later.[FB]

Store the dates in "future"; Set the period argument to 365 as forecast into the future; Check start and end data by applying the `head()` and `tail()`function:

```{r}
future <- make_future_dataframe(m, periods = 365)
head(future,2)
tail(future,2)
```

The data starts with the historical data and ends with the 365 future values.

---

# Prophet FCST - create the prediction

Next step deploys the model to the future dates. Use the `predict()` function to create the predictions for all rows (historic and future) in the "future" dataframe. The result is a forecast object as dataframe which provides a column "yhat" containing the forecast. There are additional columns available to represent uncertainty intervals and seasonal components. [FB]

The function takes the data and trains the model on a specified period. Next It will predict your specified future period. Further Prophet will retrain the data on a bigger period, predict again which will repeat until the end point is reached. [Merwe]

Create a new dataframe assigned to the "forecast" variable. Apply `predict()` on the prophet model object to generate the forecast:

```{r}
forecast <- predict(m, future)
```

---

# Prophet FCST - create the prediction

Show first and last 2 items of the prediction (yhat) with lower (yhat_lower) and upper (yhat_upper) limits. Recognize that the generated data start with the historic data and ends with the forecast data:

```{r}
head(forecast[c("ds", "yhat", "yhat_lower", "yhat_upper")],2)
tail(forecast[c("ds", "yhat", "yhat_lower", "yhat_upper")],2)
```

---

# Prophet FCST - plot the Forecast

Another Prophet built-in helper function is `plot()` to visualize the FCST. [FB]<br>
- "m" = prophet object from `prophet(data)`<br>
- "forecast" = dataframe of `predict(m, future)` function<br>
- `add_changepoints_to_plot()` to visualize the same [Package ‘prophet’]:

```{r, fig.height=4, fig.width=11}
plot(m, forecast) + add_changepoints_to_plot(m)
```

---

# Prophet FCST - plot the Forecast

To generate an interactive plot ggplotly() can be easily applied [Storozhenko]:


```{r, fig.height=5, fig.width=8, warning=FALSE}
p <- plot(m, forecast) + add_changepoints_to_plot(m)
ggplotly(p, tooltip="all", orignalData = True)
```

---

# Prophet FCST - plot the Forecast

Legend for plot on previous slide:
* **black dots** represent the number of views of Manning's Wikipedia page until end of 2016
* **blue line** represents the prediction of the prophet model including the historic values
* **light blue lines** visualizes the y upper and lower limits presenting the uncertainty interval 

To be recognized:<br>
The Prophet forecast automatically detects the saisonality, here related to NFL seasons. 

---

# Prophet FCST - Forecast components

One more built-in helper function is `prophet_plot_components()`. It provides the fcst broken down into trend, weekly and yearly seasonality. [FB]

This plot shows how Prophet has modeled trend and seasonality for the data:

```{r, fig.height=4.5}
prophet_plot_components(m, forecast)
```

---

# Prophet FCST - Forecast components

Interpretation of the plot on previous slide:

As Peyton Manning is an American football player, yearly seasonality is important, but also weekly seasonality is present. Further certain football events (like playoff games) can also be modeled. [Taylor/Letham 2]

- **Trend**: is showing the trend and a confidence intervall getting bigger at the end for the predition. Highest peek was in 2012
- **Weekly seasonality**: highest for Monday, lowest for Saturday. 
- **Yearly seasonality**: highest in beginning of the Year followed by another peak in September. Which fits to the regular football season starting in September followed by the Play-offs, Super Bowl and Pro Bowl until February. The downward trend after 2014 corresponds to the retirement of Manning in 2016.

---

# Prophet FCST - interactive plot

Another way to create an interactive plot of the forecast is using Dygraphs command `dyplot.prophet(m, forecast)`. [FB]

- "m" is again the prophet object from `prophet(data)`
- "forecast" is the dataframe returned by the `predict(m, dataframe)` function:

Source: [dyplot](https://www.rdocumentation.org/packages/airGRteaching/versions/0.2.6.29/topics/dyplot)

---

# Prophet FCST - interactive plot

```{r, dpi=65, fig.width=11}
dyplot.prophet(m, forecast)
```

---

# Fazit

- easy to apply also for non-experts
- understandable code
- optimized for forecast tasks where:
  - data is available for hours, days, or weeks
  - data is available for minimum of a few months (better year)
  - dataprovides strong seasonalities like day of week or time of year
  - important holidays / events known in advance (e.g. the Super Bowl)
  - moderate number of missing observations
  - moderate number of large outliers
  - data with historical trend changes (e.g. product launches, logging changes)
  - growth with non-linear trends
  - trend with natural limitation or saturation
- option to tweak forecast performance with parameters: 
  - in the docstrings, e.g. via ?prophet or ?fit.prophet
  - [reference manual on CRAN](https://cran.r-project.org/web/packages/prophet/prophet.pdf)

---

# References

- [Facebook Prophet documentation](https://facebook.github.io/prophet/docs/quick_start.html#r-api)<br> 
--> referenced as [FB]
- Taylor SJ, Letham B. (2017) [Forecasting at scale. PeerJ Preprints 5:e3190v2](https://doi.org/10.7287/peerj.preprints.3190v2)<br> 
--> referenced as [Taylor/Letham 1]
- Taylor SJ, Letham B. (2017) [Prophet: forecasting at scale](https://research.fb.com/prophet-forecasting-at-scale/)<br> 
--> referenced as [Taylor/Letham 2]
- Ruan van der Merwe (2018) [Implementing Facebook Prophet efficiently](https://towardsdatascience.com/implementing-facebook-prophet-efficiently-c241305405a3) <br> 
--> referenced as [Merwe]
- Tutorial ["Time Series ARIMA and Prophet"](https://www.kirenz.de/project/python-time-series/), from Prof. Dr. Jan Kirenz, Hochschulde der Medien, [Homepage](https://www.kirenz.de/) <br> 
--> referenced as [Kirenz]
- Dmitry Storozhenko (2018) [Surviving financial turmoil: time series forecasting with Prophet and R](https://medium.com/@storozhenko.dmitry/surviving-financial-turmoil-time-series-forecasting-with-prophet-and-r-105f4f4f0766) <br> 
--> referenced as [Storozhenko]
- [Peyton Manning on Wikipedia](https://de.wikipedia.org/wiki/Peyton_Manning) <br> 
--> [Manning@Wiki]
- Automatic Forecasting Procedure (2019) [Package ‘prophet’](https://cran.r-project.org/web/packages/prophet/prophet.pdf)<br> 
--> [Package ‘prophet’]

---

background-image: url(https://miro.medium.com/max/964/0*tVCene42rgUTNv9Q.png)
background-size: 400px
background-position: 50% 50%

# Thank you!  

Project available @ [https://github.com/poetzl/Prophet-with-R](https://github.com/poetzl/Prophet-with-R)

